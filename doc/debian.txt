# $Header: /data/zender/nco_20150216/nco/doc/debian.txt,v 1.46 2006-11-12 20:20:53 zender Exp $ -*-text-*-

# Purpose: Debian information for NCO netCDF Operators project
# Notes describe procedure to manipulate Debian-specific distribution

Debian:	    http://packages.debian.org/unstable/math/nco.html
Gentoo:	    http://gentoo-stable.iq-computing.de/browse?type=version&category=app-sci&package=nco&version=2.2.0

Rod05 is Bible for packaging .deb's: /data/zender/tmp/debian.pdf
Questions on procedure go to Debian Mentors <debian-mentors@lists.debian.org> 

0. Install Debian packages required to build new packages
apt-get install dh-make debhelper devscripts fakeroot gnupg debian-policy developers-reference

0.5 Create key to sign packages
   gpg --gen-key

1. Create ~/nco/debian directory to hold Debian configuration files

2. Debian build procedure recommends placing entire package source in
   subdirectory of main package. 
   For starters, we wish to create .debs of tagged releases, e.g., nco-3.1.7
   First we create a clean source distribution of nco and place it in nco-3.1.7
   Once automated, we will use cvs co -rnco-3_1_7 to get source
   Until we know what is necessary, however, we just copy a snapshot
   
   2.1 Clean all build files from development directory

cd ~/nco;make distclean;cd bld;make clean;cd ~
tar cvzf ./nco/nco.tar.gz ./nco/*
cd ~/nco;tar xvzf nco.tar.gz;mv nco nco-3.1.7
/bin/rm nco.tar.gz;tar cvzf nco-3.1.7.tar.gz ./nco-3.1.7/*
cd ~/nco/nco-3.1.7
dh_make -e zender@uci.edu -f ../nco-3.1.7.tar.gz

    2.2 The preceding steps created template debian files for a .deb,
    Those files now reside in ~/nco/debian.
    They are now checked into the CVS repository of the main distribution
    Step 2 only needs to be performed once per package
    Now that the Debian template files are a part of the upstream
    directory, future work consists of building the Debian packages

3. Build new .deb package

   3.1 First, remove detritus including *.gz files in parent directory
   from previous build

   cd ~/nco;/bin/rm *.gz
   cd ~/nco/nco-3.1.7;
   export NETCDF_LIB=/usr/lib NETCDF_INC=/usr/include
   dpkg-buildpackage -rfakeroot > foo 2>&1

4. Find out which packages new package needs for building
   From Rod02 p. 14

   strace -f -o /tmp/log ./configure
   for x in `dpkg -S ${grep open /tmp/log | perl -pe 's!.* open\(\"([^\"]*).*!$1}

5. Going backwards: How to create the Debian tarball source given
the distributed Debian files, nco_X.Y.Z-3.dsc nco_X.Y.Z-3.orig.tar.gz,
and nco_X.Y.Z-3.diff.gz  

dpkg-source -x nco_X.Y.Z-3.dsc

This dpkg-source command is functionally equivalent to applying the
Debian diff to the original source to produce Debian source:

cd /data/zender;/bin/rm -r nco-X.Y.Z.orig nco-X.Y.Z 
tar xvzf nco_X.Y.Z.orig.tar.gz # Untar original source
cp -r nco-X.Y.Z.orig nco-X.Y.Z # Create destination for patches
patch -p0 < nco_X.Y.Z-3.diff # Patch destination with Debian diff

6. To synchronize .debs with new releases, follow this procedure:
   cd ~/nco/bld
   make tags
# Put cute version-specific string in nco_ctl.c:nco_nmn_get()
# Install correct version numbers before updating Debian
# tags-query replace 3_1_7 with X_Y_Z+1
# tags-query replace 3.1.7 with X.Y.Z+1
# If tags-query replace does not work, be sure to manually change
# versions in configure.in, debian/files, doc/ANNOUNCE, doc/debian.txt,
# doc/index.shtml, doc/nco.texi, bld/nco_dst.pl, doc/VERSION 
   cd ~/nco/debian
   dch -v 3.1.7-1 # Update changelog
# For unknown reason rules file may lose its executable bit
   chmod a+x ~/nco/debian/rules
# Build Debs using Debian libraries and include
   export NETCDF_LIB=/usr/lib NETCDF_INC=/usr/include
   cd ~/nco;cvs commit -m "Preparing nco-3.1.7 release";
# -uc -us : Tell dpkg-buildpackage not to sign the package upload
# -rfakeroot : 
   cd ~/nco;dpkg-buildpackage -rfakeroot -uc -us > ~/nco/foo 2>&1
# Copy to distribution site
   scp ~/nco_3.1.7* dust.ess.uci.edu:/var/www/html/nco/src
   scp ~/nco/foo dust.ess.uci.edu:/var/www/html/nco/src/nco_3.1.7-1.dpkg-buildpackage.txt
# Save all files in emacs before tagging
# Tag CVS code after changing files in ~/nco/debian
   cd ~/nco;cvs commit -m "Preparing nco-3.1.7 release";cvs tag -c nco-3_1_7
   ${HOME}/nco/bld/nco_dst.pl --dbg=2 --bld --cln nco-3_1_7

# Location of build diagnostics for mentors to help 
http://dust.ess.uci.edu/nco/src/nco_3.1.7-1.dpkg-buildpackage.txt
http://dust.ess.uci.edu/nco/src/nco_3.1.7-1.dsc
http://dust.ess.uci.edu/nco/src/nco_3.1.7-1_i386.changes
http://dust.ess.uci.edu/nco/src/nco_3.1.7-1_i386.deb
http://dust.ess.uci.edu/nco/src/nco_3.1.7-1.tar.gz

# Becoming a Debian developer
http://www.debian.org/devel/join/newmaint
# Debian mentor FAQ
http://people.debian.org/~mpalmer/debian-mentors_FAQ.html

Work-Needing and Prospective Packages (WNPP)
Intent to Adopt (ITA)
Request for Package (RFP)
Request for Sponsor (RFS)

# NCO orphan/ITA bug
http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=273322
# netCDF orphan/ITA bug
http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=321336

# Debian QA member who is de facto NCO maintainer
Matej Vela <vela@debian.org>
# Listed as wanting to adopt nco and netcdf packages
Daniel Baumann <daniel.baumann@panthera-systems.net>
Daniel Baumann <daniel@debian.org>
# Created netCDF 3.6.1 package
Warren Turkal <wt@atmos.colostate.edu>

Matej Vela <vela@debian.org>, Daniel Baumann <daniel@debian.org>, Warren Turkal <wt@atmos.colostate.edu>

# Lintian check of packages
cd ~/nco;dpkg-buildpackage -rfakeroot -uc -us > ~/nco/foo 2>&1
sudo dpkg --install ~/nco_3.1.7-1_i386.deb
sudo dpkg --remove ~/nco_3.1.7-1_i386.deb

# Lintian check of packages
zender@ashes:~$ lintian ~/nco_3.1.7-1_i386.deb
E: nco: doc-base-file-references-missing-file nco:15 /usr/share/doc/nco/nco.html

# Warnings/errors in .build to fix
libtool: install: warning: remember to run `libtool --finish /usr/lib/nco'
libtool: install: warning: `libnco.la' has not been installed in `/usr/lib/nco'
libtool: install: warning: `libnco.la' has not been installed in `/usr/lib/nco'
libtool: install: warning: `libnco.la' has not been installed in `/usr/lib/nco'
libtool: install: warning: `libnco.la' has not been installed in `/usr/lib/nco'
libtool: install: warning: `libnco.la' has not been installed in `/usr/lib/nco'
libtool: install: warning: `libnco.la' has not been installed in `/usr/lib/nco'
dpkg-shlibdeps: warning: could not find any packages for libnco-3.1.7.so
dpkg-shlibdeps: warning: unable to find dependency information for shared library libnco (soname 3.1.7, path libnco-3.1.7.so, dependency field Depends)
dh_builddeb tar: -: file name read contains nul character

# From Thijs Kinkhorst <thijs@debian.org>
- Your package is "Debian native" while there's no reason to. You should
make it a regular package, i.e. with an orig.tar.gz as it is released
upstream, and a .diff.gz containing Debian-specific changes.

As with the specifics of your package the following:
- You have put the debian/ directory into upstream CVS. This is no
problem, but it must *not* be in any released tarballs. There's detailed
information / discussion about this to be found in the -mentors list
archives, but in short: this gets weird if someone changes the package
within Debian without committing it to upstream (e.g. a later NMU).
